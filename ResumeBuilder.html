<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Builder</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Merriweather:ital,wght@0,300;0,700;1,400&family=Fira+Code:wght@400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&family=Oswald:wght@400;600&family=Roboto+Slab:wght@300;400;700&family=Raleway:wght@300;400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;600&family=Lora:ital,wght@0,400;0,600;1,400&family=Karla:wght@400;700&family=Space+Mono:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Source+Sans+Pro:wght@400;600&family=PT+Sans:wght@400;700&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --primary: #2d3748;
            --accent: #2b6cb0;
            --accent-hover: #2c5282;
            --bg-page: #ffffff;
            --text-main: #1a202c;
            --text-muted: #4a5568;
            --border-color: #e2e8f0;
            --page-width: 210mm;
            --page-height: 297mm;
            --page-padding: 40px;
            --font-head: 'Inter', sans-serif;
            --font-body: 'Inter', sans-serif;
            --font-size-name: 2.2rem;
            --font-size-section: 1.1rem;
            --font-size-body: 0.9rem;
            --section-spacing: 25px;
            --line-height: 1.5;
            --sidebar-width: 30%;
            --column-gap: 30px;
            --row-gap: 20px;
            --ui-height: 60px;
            --status-height: 30px;
        }

        /* --- RESET & UI --- */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            background: #cbd5e0;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SPLASH SCREEN --- */
        .splash-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(26, 32, 44, 0.98); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(10px); transition: opacity 0.5s ease;
        }
        .splash-overlay.hidden { opacity: 0; pointer-events: none; }
        .splash-box { 
            background: white; padding: 50px; border-radius: 16px; 
            text-align: center; max-width: 550px; width: 90%; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
            border-top: 5px solid var(--accent);
        }
        .splash-logo { font-size: 3rem; color: var(--accent); margin-bottom: 20px; }
        .splash-actions { display: flex; gap: 20px; justify-content: center; margin-top: 30px; }
        .btn-splash { padding: 14px 30px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: transform 0.2s; font-size: 1rem; }
        .btn-splash:hover { transform: translateY(-2px); }
        .btn-new { background: linear-gradient(135deg, #2b6cb0, #2c5282); color: white; box-shadow: 0 4px 6px rgba(43, 108, 176, 0.3); }
        .btn-open { background: #edf2f7; color: #2d3748; border: 1px solid #e2e8f0; }

        /* --- TOOLBAR --- */
        .toolbar {
            height: var(--ui-height); background: #1a202c; color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 100; flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .toolbar-left, .toolbar-right { display: flex; align-items: center; gap: 15px; }
        .toolbar-group { display: flex; flex-direction: column; }
        .toolbar-group label { font-size: 9px; text-transform: uppercase; color: #a0aec0; font-weight: bold; letter-spacing: 0.5px; }
        select, input[type="color"] { background: #2d3748; color: white; border: 1px solid #4a5568; padding: 4px 8px; border-radius: 4px; height: 30px; outline: none; cursor: pointer; }
        select:hover { border-color: var(--accent); }
        .btn-tool { background: #4a5568; border: 1px solid #718096; color: white; padding: 0 15px; height: 36px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; transition: all 0.2s; }
        .btn-tool:hover { background: #2d3748; border-color: var(--accent); color: #bee3f8; }
        .btn-tool.active { background: var(--accent); border-color: var(--accent); color: white; box-shadow: 0 0 10px rgba(43, 108, 176, 0.5); }
        .btn-primary { background: #e53e3e; border-color: #c53030; }
        .btn-primary:hover { background: #c53030; border-color: #9b2c2c; }

        /* --- STATUS BAR --- */
        .status-bar {
            height: var(--status-height); background: #2d3748; color: #a0aec0;
            font-size: 0.75rem; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; border-top: 1px solid #4a5568; z-index: 90; flex-shrink: 0;
        }
        .status-group { display: flex; gap: 20px; }
        .status-item { display: flex; align-items: center; gap: 5px; }
        .status-item i { color: var(--accent); }

        /* --- EXPORT SIDEBAR (LEFT) --- */
        .export-sidebar {
            position: fixed; left: -400px; top: var(--ui-height); bottom: var(--status-height); width: 400px;
            background: #1a202c; color: white; z-index: 200;
            overflow-y: auto; padding: 30px; transition: left 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 4px 0 20px rgba(0,0,0,0.3); border-right: 1px solid #4a5568;
        }
        .export-sidebar.open { left: 0; }
        
        .export-card {
            background: #2d3748; border: 1px solid #4a5568; border-radius: 8px; padding: 20px;
            margin-bottom: 20px; transition: all 0.2s;
        }
        .export-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .export-card h4 { margin: 0 0 10px 0; font-size: 1.1rem; color: #e2e8f0; display: flex; align-items: center; gap: 10px; }
        .export-card p { margin: 0 0 15px 0; font-size: 0.85rem; color: #a0aec0; }
        .export-btn-large {
            width: 100%; padding: 12px; background: var(--accent); color: white; border: none;
            border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; gap: 10px; font-size: 1rem;
            transition: background 0.2s;
        }
        .export-btn-large:hover { background: var(--accent-hover); }
        .export-btn-large.secondary { background: #4a5568; }
        .export-btn-large.secondary:hover { background: #718096; }

        .export-sidebar h3 { 
            font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; 
            color: var(--accent); margin-bottom: 20px; border-bottom: 1px solid #4a5568; padding-bottom: 10px;
        }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 0.75rem; color: #a0aec0; margin-bottom: 8px; text-transform: uppercase; }
        .form-input {
            width: 100%; background: #2d3748; border: 1px solid #4a5568;
            color: white; padding: 10px; border-radius: 6px; font-family: inherit;
        }
        .form-input:focus { border-color: var(--accent); outline: none; }

        /* --- CUSTOMIZATION PANEL (RIGHT) --- */
        .customize-panel {
            position: fixed; right: -380px; top: var(--ui-height); bottom: var(--status-height); width: 380px;
            background: #1a202c; color: white; z-index: 200;
            overflow-y: auto; padding: 20px; transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            border-left: 1px solid #4a5568;
        }
        .customize-panel.open { right: 0; }
        .customize-panel h3 { 
            font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; 
            color: #63b3ed; margin: 25px 0 15px 0; padding-bottom: 8px;
            border-bottom: 1px solid #2d3748;
        }
        .customize-panel h3:first-child { margin-top: 0; }
        
        .control-group { margin-bottom: 15px; }
        .control-group label { 
            display: block; font-size: 0.75rem; color: #a0aec0; 
            margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .control-group input[type="range"] {
            width: 100%; height: 6px; border-radius: 3px;
            background: #2d3748; outline: none; cursor: pointer;
        }
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 16px; height: 16px; border-radius: 50%;
            background: #3182ce; cursor: pointer;
        }
        .control-group input[type="range"]::-moz-range-thumb {
            width: 16px; height: 16px; border-radius: 50%;
            background: #3182ce; cursor: pointer; border: none;
        }
        .control-group select, .control-group input[type="color"], .control-group input[type="number"] {
            width: 100%; background: #2d3748; color: white;
            border: 1px solid #4a5568; padding: 8px; border-radius: 4px;
        }
        .control-group input[type="number"] {
            -moz-appearance: textfield;
        }
        .control-group input[type="number"]::-webkit-inner-spin-button,
        .control-group input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .range-value { 
            display: inline-block; float: right; font-size: 0.75rem; 
            color: #63b3ed; font-weight: bold;
        }
        .btn-reset {
            width: 100%; padding: 10px; background: #e53e3e;
            color: white; border: none; border-radius: 4px;
            cursor: pointer; margin-top: 20px; font-weight: bold;
        }
        .btn-reset:hover { background: #c53030; }

        .color-preset {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 8px; margin-top: 10px;
        }
        .color-preset-btn {
            height: 40px; border-radius: 6px; border: 2px solid transparent;
            cursor: pointer; transition: all 0.2s;
        }
        .color-preset-btn:hover { transform: scale(1.1); border-color: white; }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4a5568;
            transition: 0.3s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #3182ce;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .counter-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .counter-btn {
            width: 30px;
            height: 30px;
            background: #4a5568;
            border: 1px solid #718096;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .counter-btn:hover {
            background: #2d3748;
        }
        .counter-display {
            flex: 1;
            text-align: center;
            background: #2d3748;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #4a5568;
        }

        /* --- PREVIEW AREA --- */
        .preview-area { 
            flex: 1; overflow-y: auto; display: flex; flex-direction: column; align-items: center;
            padding: 40px; background-image: radial-gradient(#a0aec0 1px, transparent 1px); 
            background-size: 20px 20px; transition: padding 0.3s ease;
            position: relative;
        }
        .preview-area.panel-open-left { padding-left: 440px; }
        .preview-area.panel-open-right { padding-right: 400px; }
        
        /* --- PAGE STRUCTURE --- */
        .page {
            width: var(--page-width); min-height: var(--page-height);
            background-color: var(--bg-page);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            padding: var(--page-padding);
            color: var(--text-main);
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: auto 1fr;
            column-gap: var(--column-gap);
            row-gap: var(--row-gap);
            grid-template-areas: "header header" "sidebar main";
            line-height: var(--line-height);
            margin-bottom: 40px;
            page-break-after: always;
            transition: all 0.2s ease;
        }
        
        /* Compact Spacing Mode */
        body.compact-mode .page {
            row-gap: 10px;
            column-gap: 15px;
        }
        body.compact-mode section {
            margin-bottom: 15px;
        }

        .page:last-child {
            margin-bottom: 0;
        }

        /* Single page mode */
        body.single-page .page {
            height: var(--page-height);
            overflow: hidden;
        }

        /* --- EDITING UX & CONTROLS --- */
        [contenteditable]:hover { outline: 1px dashed #cbd5e0; background: rgba(0,0,0,0.02); cursor: text; }
        [contenteditable]:focus { outline: 2px solid var(--accent); background: rgba(66, 153, 225, 0.1); }
        
        /* Move Controls */
        section, .entry {
            position: relative;
        }
        .move-controls {
            position: absolute;
            right: 0;
            top: 0;
            display: none;
            flex-direction: column;
            gap: 2px;
            z-index: 10;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .entry:hover .move-controls,
        section:hover .move-controls {
            display: flex;
        }
        .move-btn {
            background: none;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            padding: 2px 4px;
            font-size: 10px;
        }
        .move-btn:hover {
            color: var(--accent);
            background: #edf2f7;
        }

        .section-controls { opacity: 0; text-align: center; height: 0; overflow: hidden; }
        section:hover .section-controls { opacity: 1; height: auto; margin: 10px 0; }
        .btn-mini { background: #48bb78; color: white; border: none; border-radius: 4px; padding: 2px 8px; font-size: 11px; cursor: pointer; }
        .btn-rm { color: #e53e3e; cursor: pointer; margin-left: auto; font-size: 11px; display: none; }
        .entry:hover .btn-rm { display: block; position: absolute; right: 0; top: 0; background: white; border: 1px solid #eee; padding-left: 5px; z-index: 5; }

        /* --- BASE TYPOGRAPHY --- */
        h1, h2, h3, p, ul { margin: 0; }
        header { grid-area: header; }
        aside { grid-area: sidebar; }
        main { grid-area: main; }
        
        h1.name { 
            font-family: var(--font-head); 
            font-size: var(--font-size-name); 
            font-weight: 700; color: var(--accent); 
            line-height: 1.1; 
        }
        .tagline { font-size: 1.1rem; color: var(--text-muted); margin-bottom: 10px; }
        .contact-info { display: flex; flex-wrap: wrap; gap: 12px; font-size: 0.85rem; color: var(--text-main); margin-top: 10px; }
        
        section { margin-bottom: var(--section-spacing); position: relative; }
        h2.section-title { 
            font-family: var(--font-head); 
            font-size: var(--font-size-section); 
            text-transform: uppercase; letter-spacing: 1px; color: var(--accent); 
            border-bottom: 2px solid var(--border-color); padding-bottom: 5px; 
            margin-bottom: 15px; 
        }

        .entry { margin-bottom: 15px; position: relative; }
        .job-head { display: flex; justify-content: space-between; font-weight: 700; font-family: var(--font-head); font-size: 1rem; }
        .job-sub { display: flex; justify-content: space-between; color: var(--text-muted); font-size: 0.9rem; font-style: italic; margin-bottom: 5px; }
        ul { padding-left: 1.1rem; line-height: var(--line-height); font-size: var(--font-size-body); font-family: var(--font-body); }
        li { margin-bottom: 3px; }
        p { font-size: var(--font-size-body); font-family: var(--font-body); }

        /* ========================================= */
        /* THE TEMPLATE LIBRARY (1 - 40)          */
        /* ========================================= */

        /* 1-10: THE FOUNDATIONS */
        .tpl-classic { --font-head: 'Inter'; }
        
        .tpl-modern-split .page { grid-template-areas: "sidebar main"; grid-template-rows: 1fr; padding: 0; }
        .tpl-modern-split aside { background: var(--primary); color: white; padding: 40px 30px; }
        .tpl-modern-split main { padding: 40px; }
        .tpl-modern-split header { grid-area: sidebar; margin-bottom: 40px; }
        .tpl-modern-split h1.name, .tpl-modern-split h2.section-title { color: white; }
        .tpl-modern-split .contact-info { color: #cbd5e0; flex-direction: column; }
        
        .tpl-executive { --font-head: 'Merriweather'; --font-body: 'Merriweather'; }
        .tpl-executive .page { grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; }
        .tpl-executive header { text-align: center; border-bottom: 3px double var(--accent); padding-bottom: 20px; margin-bottom: 30px; }
        .tpl-executive .contact-info { justify-content: center; }
        .tpl-executive aside { column-count: 2; padding-top: 20px; border-top: 1px solid #eee; }

        .tpl-tech { --font-head: 'Fira Code', monospace; --font-body: 'Fira Code', monospace; }
        .tpl-tech h1.name::before { content: '<'; opacity:0.5; } .tpl-tech h1.name::after { content: ' />'; opacity:0.5; }
        .tpl-tech h2.section-title { background: #edf2f7; padding: 5px 10px; border-left: 4px solid var(--accent); border-bottom: none; }
        .tpl-tech aside { display: flex; gap: 30px; flex-wrap: wrap; }
        .tpl-tech .page { grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; }

        .tpl-minimalist .page { grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; padding: 60px; }
        .tpl-minimalist h2.section-title { border: none; font-size: 0.9rem; color: #718096; letter-spacing: 2px; }
        .tpl-minimalist h1.name { font-weight: 300; font-size: 3rem; color: black; }
        
        .tpl-timeline { --font-head: 'Roboto Slab'; }
        .tpl-timeline .page { grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; }
        .tpl-timeline .entry { border-left: 2px solid var(--accent); padding-left: 20px; margin-left: 5px; }

        .tpl-elegant { --font-head: 'Playfair Display'; --font-body: 'Lato'; text-align: center; }
        .tpl-elegant .page { grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; }
        .tpl-elegant h1.name { font-style: italic; font-size: 3.5rem; }
        .tpl-elegant h2.section-title { text-align: center; font-style: italic; text-transform: lowercase; border: none; }
        .tpl-elegant h2.section-title::after { content:''; display: block; width: 40px; height: 1px; background: var(--accent); margin: 5px auto; }
        .tpl-elegant ul { text-align: left; display: inline-block; }

        .tpl-metro { background-color: #f7fafc; }
        .tpl-metro .page { background: #f4f4f4; padding: 30px; grid-template-columns: 35% 1fr; gap: 20px; }
        .tpl-metro header, .tpl-metro section { background: white; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-radius: 4px; }
        .tpl-metro h2.section-title { background: var(--accent); color: white; padding: 4px 10px; display: inline-block; border: none; transform: translateY(-30px); margin-bottom: -15px; }

        .tpl-bold-left .page { border-left: 15mm solid var(--accent); padding-left: 40px; grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; }
        .tpl-bold-left h1.name { font-weight: 900; letter-spacing: -1px; }

        .tpl-swiss { --font-head: 'Arial'; }
        .tpl-swiss .page { grid-template-columns: 25% 1fr; padding-top: 60px; border-top: 10px solid var(--accent); }
        .tpl-swiss h1.name { font-size: 4rem; line-height: 0.9; grid-column: 1 / -1; margin-bottom: 40px; }
        .tpl-swiss h2.section-title { font-weight: 900; color: black; border: none; border-top: 4px solid black; padding-top: 10px; }

        /* 11-20: EXPANDED VARIETY */
        .tpl-banner .page { padding: 0; grid-template-rows: auto 1fr; grid-template-areas: "header header" "sidebar main"; }
        .tpl-banner header { background: var(--accent); padding: 50px; color: white; }
        .tpl-banner h1.name, .tpl-banner .tagline, .tpl-banner .contact-info { color: white; }
        .tpl-banner main, .tpl-banner aside { padding: 40px; }

        .tpl-compact { font-size: 13px; }
        .tpl-compact .page { padding: 30px; gap: 15px; }
        .tpl-compact h1.name { font-size: 1.8rem; }
        .tpl-compact h2.section-title { margin-bottom: 8px; font-size: 1rem; border-bottom: 1px solid #ccc; }
        
        .tpl-sidebar-right .page { grid-template-columns: 1fr var(--sidebar-width); grid-template-areas: "header header" "main sidebar"; }
        .tpl-sidebar-right aside { border-left: 1px solid #eee; padding-left: 30px; }
        .tpl-sidebar-right main { padding-right: 30px; }

        .tpl-geometric { --font-head: 'Oswald'; }
        .tpl-geometric h1.name { text-transform: uppercase; letter-spacing: 2px; }
        .tpl-geometric h2.section-title { background: black; color: white; padding: 5px 15px; transform: skewX(-10deg); display: inline-block; border: none; }
        
        .tpl-soft { --font-head: 'Raleway'; --font-body: 'Open Sans'; }
        .tpl-soft h2.section-title { border: none; background: #edf2f7; color: var(--accent); padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; }
        
        .tpl-underline h2.section-title { border-bottom: 5px solid var(--accent); padding-bottom: 0; display: inline-block; width: auto; }
        .tpl-underline .page { grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; }
        .tpl-underline aside { display: flex; gap: 30px; border-top: 5px solid #eee; padding-top: 20px; margin-top: 20px; }

        .tpl-grid-box .page { display: block; padding: 40px; }
        .tpl-grid-box section { border: 1px solid #e2e8f0; padding: 20px; break-inside: avoid; }
        .tpl-grid-box header { margin-bottom: 20px; text-align: center; }
        .tpl-grid-box main, .tpl-grid-box aside { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }

        .tpl-warm { --font-head: 'Lora'; --font-body: 'Karla'; }
        .tpl-warm .page { background: #fffaf0; color: #4a4036; grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; }
        .tpl-warm h1.name { color: #8d6e63; font-style: italic; }
        .tpl-warm h2.section-title { color: #8d6e63; border-bottom: 1px solid #d7ccc8; }
        
        .tpl-futuristic { --font-head: 'Montserrat'; text-transform: uppercase; }
        .tpl-futuristic h1.name { letter-spacing: 5px; text-align: center; }
        .tpl-futuristic .tagline, .tpl-futuristic .contact-info { text-align: center; }
        .tpl-futuristic h2.section-title { border: 2px solid black; padding: 5px; text-align: center; font-weight: 800; }
        .tpl-futuristic .page { grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; }

        .tpl-leaf { --font-head: 'Lato'; }
        .tpl-leaf h2.section-title { border-bottom: none; position: relative; padding-left: 15px; }
        .tpl-leaf h2.section-title::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: var(--accent); border-radius: 5px; }
        
        /* 21-30: DISTINCT & BOLD */
        .tpl-brutalist { --font-head: 'Space Mono'; --font-body: 'Space Mono'; }
        .tpl-brutalist .page { border: 4px solid black; grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; padding: 20px; }
        .tpl-brutalist header { border-bottom: 4px solid black; padding-bottom: 20px; margin-bottom: 20px; }
        .tpl-brutalist h2.section-title { background: black; color: white; padding: 10px; border: none; font-weight: bold; text-transform: uppercase; }
        .tpl-brutalist .entry { border: 2px solid black; padding: 15px; margin-bottom: 15px; }

        .tpl-journal { --font-head: 'Playfair Display'; --font-body: 'Merriweather'; }
        .tpl-journal .page { grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; }
        .tpl-journal header { text-align: center; border-bottom: 1px solid #ccc; border-top: 1px solid #ccc; padding: 20px 0; margin-bottom: 20px; }
        .tpl-journal h1.name { font-size: 3.5rem; }
        .tpl-journal main { column-count: 2; column-gap: 30px; }
        .tpl-journal aside { column-count: 3; font-size: 0.8rem; border-top: 2px solid black; margin-top: 20px; padding-top: 20px; }

        .tpl-azure .page { grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; padding: 50px; }
        .tpl-azure h2.section-title { background: #ebf8ff; color: var(--accent); padding: 10px 20px; border-left: 5px solid var(--accent); border-bottom: none; }
        
        .tpl-pillars .page { grid-template-columns: 1fr 1fr; grid-template-areas: "header header" "main sidebar"; gap: 40px; }
        .tpl-pillars main, .tpl-pillars aside { padding: 0; }
        .tpl-pillars header { text-align: center; margin-bottom: 40px; }
        .tpl-pillars aside { border-left: 1px solid #eee; padding-left: 40px; }

        .tpl-monochrome { --accent: #000000 !important; --text-muted: #333 !important; }
        .tpl-monochrome .page { grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; }
        .tpl-monochrome h1.name { background: black; color: white; padding: 10px 20px; display: inline-block; }
        .tpl-monochrome h2.section-title { border-bottom: 4px solid black; font-weight: 900; color: black; }

        .tpl-terminal { --font-head: 'Fira Code'; --font-body: 'Fira Code'; }
        .tpl-terminal .page { background: white; color: black; grid-template-rows: auto 1fr; grid-template-areas: "header header" "sidebar main"; }
        .tpl-terminal header { background: #1a202c; color: #48bb78; padding: 30px; font-family: monospace; }
        .tpl-terminal h1.name { color: #48bb78; }
        .tpl-terminal .tagline { color: #a0aec0; }
        .tpl-terminal .contact-info { color: #fff; }
        .tpl-terminal h2.section-title { color: #1a202c; border-bottom: 2px dashed #1a202c; }

        .tpl-float .page { background: #f0f2f5; padding: 60px; grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; }
        .tpl-float header, .tpl-float section { background: white; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-radius: 8px; }
        .tpl-float h2.section-title { border: none; color: var(--accent); font-size: 1.2rem; }

        .tpl-codeblock { --font-head: 'Fira Code', monospace; }
        .tpl-codeblock h2.section-title::before { content: 'function '; color: #805ad5; }
        .tpl-codeblock h2.section-title::after { content: '() {'; color: #805ad5; }
        .tpl-codeblock section::after { content: '}'; display: block; margin-top: 10px; color: #a0aec0; }
        .tpl-codeblock .page { grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; }

        .tpl-fashion { --font-head: 'Playfair Display'; }
        .tpl-fashion h1.name { font-size: 4rem; text-transform: uppercase; letter-spacing: -2px; line-height: 0.8; }
        .tpl-fashion h2.section-title { font-size: 3rem; opacity: 0.1; position: absolute; right: 0; top: -20px; z-index: 0; pointer-events: none; border: none; }
        .tpl-fashion section { z-index: 1; position: relative; margin-top: 40px; }
        .tpl-fashion .page { grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; overflow: hidden; }

        /* 31-40: FINAL MIX */
        .tpl-spark { --font-head: 'Nunito', sans-serif; }
        .tpl-spark .page { grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; }
        .tpl-spark h2.section-title { border: none; display: flex; align-items: center; gap: 10px; }
        .tpl-spark h2.section-title::before { content: ''; width: 8px; height: 8px; background: var(--accent); border-radius: 50%; }

        .tpl-leftist .page { grid-template-columns: 80px 1fr; grid-template-areas: "header header" "sidebar main"; }
        .tpl-leftist aside { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); border-left: 1px solid #eee; padding: 20px; text-align: right; }
        .tpl-leftist main { border-left: 2px solid var(--accent); padding-left: 30px; }
        .tpl-leftist header { border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 20px; }

        .tpl-cards-dark { background-color: #2d3748; }
        .tpl-cards-dark .page { background: #1a202c; color: #cbd5e0; padding: 30px; gap: 20px; grid-template-columns: 30% 1fr; }
        .tpl-cards-dark header, .tpl-cards-dark section { background: #2d3748; padding: 20px; border-radius: 8px; }
        .tpl-cards-dark h1.name { color: white; }
        .tpl-cards-dark h2.section-title { border-bottom: 1px solid #4a5568; color: var(--accent); }

        .tpl-asym .page { grid-template-columns: 1.5fr 1fr; grid-template-areas: "header header" "main sidebar"; }
        .tpl-asym header { text-align: right; border-right: 10px solid var(--accent); padding-right: 20px; }
        .tpl-asym h1.name { font-size: 3rem; }

        .tpl-clean-slate .page { grid-template-columns: 1fr; grid-template-areas: "header" "main" "sidebar"; text-align: center; }
        .tpl-clean-slate header { margin-bottom: 50px; }
        .tpl-clean-slate h2.section-title { display: inline-block; border: 1px solid var(--border-color); padding: 5px 20px; border-radius: 50px; font-size: 0.8rem; letter-spacing: 2px; }
        .tpl-clean-slate .job-head, .tpl-clean-slate .job-sub { justify-content: center; }

        .tpl-hero .page { grid-template-rows: 200px 1fr; grid-template-columns: 1fr 30%; grid-template-areas: "header header" "main sidebar"; padding: 0; }
        .tpl-hero header { background: linear-gradient(135deg, var(--accent), var(--primary)); color: white; display: flex; flex-direction: column; justify-content: center; padding: 40px; }
        .tpl-hero h1.name { color: white; font-size: 3rem; }
        .tpl-hero .tagline, .tpl-hero .contact-info { color: rgba(255,255,255,0.8); }
        .tpl-hero main, .tpl-hero aside { padding: 40px; }

        .tpl-border-box .page { padding: 40px; border: 1px solid black; margin: 20px auto; width: calc(var(--page-width) - 40px); }
        .tpl-border-box h2.section-title { border: 1px solid black; padding: 5px; text-align: center; font-weight: bold; color: black; background: #eee; }

        .tpl-top-bar .page { border-top: 20px solid var(--accent); grid-template-columns: 1fr 1fr; grid-template-areas: "header header" "main sidebar"; }
        
        .tpl-dots .page { grid-template-columns: 10% 1fr; grid-template-areas: "header header" "sidebar main"; }
        .tpl-dots aside { text-align: right; border-right: 1px dashed #ccc; padding-right: 20px; }
        .tpl-dots main { padding-left: 20px; }

        .tpl-mint { --accent: #38b2ac !important; --font-head: 'Montserrat'; }
        .tpl-mint h2.section-title { color: #2c7a7b; border-bottom: 2px solid #b2f5ea; }
        .tpl-mint h1.name { color: #234e52; }

        /* --- BACKGROUNDS --- */
        .bg-plain { background-image: none; }
        .bg-dots { background-image: radial-gradient(#cbd5e0 1px, transparent 1px); background-size: 15px 15px; }
        .bg-lines { background-image: repeating-linear-gradient(0deg, transparent, transparent 24px, #e2e8f0 25px); }
        .bg-grid { background-image: linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px); background-size: 20px 20px; }
        .bg-linen { background-color: #fafbf9; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E"); }

        /* --- PRINT STYLES --- */
        @page {
            size: A4;
            margin: 0;
        }

        @media print {
            @page {
                size: A4 portrait;
                margin: 0;
            }
            
            html, body { 
                height: auto; 
                overflow: visible; 
                background: white;
                margin: 0;
                padding: 0;
            }
            
            .toolbar, .status-bar, .splash-overlay, .customize-panel, .export-sidebar, .move-controls, .btn-rm { 
                display: none !important; 
            }
            
            .preview-area { 
                padding: 0 !important;
                margin: 0 !important;
                display: block;
                background: none !important;
            }
            
            .page { 
                margin: 0 !important;
                box-shadow: none !important;
                width: 210mm !important;
                min-height: 297mm !important;
                max-height: 297mm;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                color-adjust: exact;
                page-break-after: always;
                page-break-inside: avoid;
            }

            .page:last-child {
                page-break-after: auto;
            }
            
            .section-controls { 
                display: none !important; 
            }
            
            /* Preserve template colors in print */
            .tpl-modern-split aside { 
                background-color: var(--primary) !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .tpl-banner header { 
                background: var(--accent) !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .tpl-hero header { 
                background: linear-gradient(135deg, var(--accent), var(--primary)) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .tpl-terminal header {
                background: #1a202c !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .tpl-cards-dark .page,
            .tpl-cards-dark header,
            .tpl-cards-dark section {
                background-color: #1a202c !important;
                color: #cbd5e0 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body class="tpl-classic bg-plain single-page">

    <div class="splash-overlay" id="splashScreen">
        <div class="splash-box">
            <div class="splash-logo"><i class="fas fa-file-signature"></i></div>
            <h1>Resume Builder Pro</h1>
            <p>Professional resumes, smart pagination, and advanced export options.</p>
            <div class="splash-actions">
                <button class="btn-splash btn-new" onclick="closeSplash()"><i class="fas fa-plus"></i> Create New</button>
                <button class="btn-splash btn-open" onclick="triggerLoad()"><i class="fas fa-folder-open"></i> Open Project</button>
            </div>
        </div>
    </div>
    <input type="file" id="fileLoader" accept=".resume" style="display: none;" onchange="handleFileLoad(this)">

    <!-- TOOLBAR -->
    <div class="toolbar">
        <div class="toolbar-left">
            <button class="btn-tool" onclick="toggleExportSidebar()">
                <i class="fas fa-file-export"></i> Export
            </button>
            <div class="toolbar-group">
                <label>Template</label>
                <select id="templateSelect" onchange="applyTemplate(this.value)" style="width: 140px;">
                    <option value="tpl-classic">Classic</option>
                    <option value="tpl-modern-split">Modern Split</option>
                    <option value="tpl-executive">Executive</option>
                    <option value="tpl-tech">Tech / Mono</option>
                    <option value="tpl-minimalist">Minimalist</option>
                    <option value="tpl-timeline">Timeline</option>
                    <option value="tpl-elegant">Elegant Serif</option>
                    <option value="tpl-metro">Metro Cards</option>
                    <option value="tpl-bold-left">Bold Left</option>
                    <option value="tpl-swiss">Swiss Grid</option>
                    <option value="tpl-banner">Banner Header</option>
                    <option value="tpl-compact">Compact</option>
                    <option value="tpl-futuristic">Futuristic</option>
                    <option value="tpl-brutalist">Brutalist</option>
                    <option value="tpl-codeblock">Code Block</option>
                    <option value="tpl-fashion">High Fashion</option>
                    <option value="tpl-hero">Hero Header</option>
                    <option value="tpl-mint">Mint Fresh</option>
                </select>
            </div>
            <div class="toolbar-group">
                <label>Paper</label>
                <select id="bgSelect" onchange="applyBg(this.value)">
                    <option value="bg-plain">Plain</option>
                    <option value="bg-linen">Linen</option>
                    <option value="bg-dots">Dots</option>
                    <option value="bg-lines">Lined</option>
                    <option value="bg-grid">Graph</option>
                </select>
            </div>
             <div class="toolbar-group">
                <label>Color</label>
                <input type="color" id="accentColor" value="#2b6cb0" oninput="applyColor(this.value)" style="width:40px; padding:0;">
            </div>
        </div>

        <div class="toolbar-right">
            <button class="btn-tool" id="compactBtn" onclick="toggleCompactMode()" title="Toggle Compact Spacing">
                <i class="fas fa-compress-alt"></i> Compact
            </button>
            <button class="btn-tool" id="customizeBtn" onclick="toggleCustomize()">
                <i class="fas fa-sliders-h"></i> Customize
            </button>
            <button class="btn-tool" onclick="saveProject()">
                <i class="fas fa-save"></i> Save
            </button>
        </div>
    </div>

    <!-- STATUS BAR -->
    <div class="status-bar">
        <div class="status-group">
            <div class="status-item"><i class="fas fa-file-alt"></i> <span id="status-page-count">Page 1 of 1</span></div>
            <div class="status-item"><i class="fas fa-font"></i> <span id="status-word-count">0 Words</span></div>
        </div>
        <div class="status-group">
            <div class="status-item" style="color: #718096;">Resume Builder V7</div>
        </div>
    </div>

    <!-- EXPORT SIDEBAR (LEFT) -->
    <div class="export-sidebar" id="exportSidebar">
        <h3>Export Center</h3>
        
        <div class="form-group">
            <label>Document Filename</label>
            <input type="text" id="exportFilename" class="form-input" value="My_Resume" placeholder="e.g. John_Doe_Resume">
        </div>

        <div class="export-card">
            <h4><i class="fas fa-file-pdf" style="color:#e53e3e"></i> PDF Document</h4>
            <p>High quality vector output. Best for printing and emailing.</p>
            <button class="export-btn-large" onclick="exportPDF()">
                <i class="fas fa-download"></i> Download PDF
            </button>
        </div>

        <div class="export-card">
            <h4><i class="fas fa-file-word" style="color:#2b6cb0"></i> DOCX Document</h4>
            <p>Microsoft Word format. Best for further editing.</p>
            <button class="export-btn-large secondary" onclick="exportDOCX()">
                <i class="fas fa-download"></i> Download DOCX
            </button>
        </div>

        <div class="export-card">
            <h4><i class="fas fa-file-image" style="color:#ed8936"></i> PNG Image</h4>
            <p>Raster image format. High compatibility, fixed size.</p>
            <button class="export-btn-large secondary" onclick="exportPNG()">
                <i class="fas fa-download"></i> Download PNG
            </button>
        </div>

        <div class="export-card">
            <h4><i class="fas fa-bezier-curve" style="color:#805ad5"></i> SVG Vector</h4>
            <p>Scalable Vector Graphics. Infinite scaling.</p>
            <button class="export-btn-large secondary" onclick="exportSVG()">
                <i class="fas fa-download"></i> Download SVG
            </button>
        </div>

        <button class="btn-reset" onclick="closeExportSidebar()">Close Panel</button>
    </div>

    <!-- CUSTOMIZATION PANEL (RIGHT) -->
    <div class="customize-panel" id="customizePanel">
        <h3><i class="fas fa-file-alt"></i> Document Layout</h3>
        
        <div class="control-group">
            <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span>Multi-Page Resume</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="multiPageToggle" onchange="togglePageMode()">
                    <span class="toggle-slider"></span>
                </label>
            </label>
            <p style="font-size: 0.7rem; color: #718096; margin-top: 5px;">Enable for 2+ page resumes</p>
        </div>

        <h3><i class="fas fa-briefcase"></i> Content Sections</h3>
        
        <div class="control-group">
            <label>Number of Jobs</label>
            <div class="counter-control">
                <button class="counter-btn" onclick="adjustJobCount(-1)">−</button>
                <div class="counter-display" id="jobCountDisplay">3</div>
                <button class="counter-btn" onclick="adjustJobCount(1)">+</button>
            </div>
        </div>

        <div class="control-group">
            <label>Number of Schools</label>
            <div class="counter-control">
                <button class="counter-btn" onclick="adjustEducationCount(-1)">−</button>
                <div class="counter-display" id="eduCountDisplay">1</div>
                <button class="counter-btn" onclick="adjustEducationCount(1)">+</button>
            </div>
        </div>

        <h3><i class="fas fa-font"></i> Typography</h3>
        
        <div class="control-group">
            <label>Heading Font</label>
            <select id="fontHead" onchange="updateCSS('--font-head', this.value)">
                <option value="'Inter', sans-serif">Inter</option>
                <option value="'Merriweather', serif">Merriweather</option>
                <option value="'Playfair Display', serif">Playfair Display</option>
                <option value="'Montserrat', sans-serif">Montserrat</option>
                <option value="'Oswald', sans-serif">Oswald</option>
                <option value="'Roboto Slab', serif">Roboto Slab</option>
                <option value="'Fira Code', monospace">Fira Code</option>
                <option value="'Space Mono', monospace">Space Mono</option>
            </select>
        </div>

        <div class="control-group">
            <label>Body Font</label>
            <select id="fontBody" onchange="updateCSS('--font-body', this.value)">
                <option value="'Inter', sans-serif">Inter</option>
                <option value="'Open Sans', sans-serif">Open Sans</option>
                <option value="'Lato', sans-serif">Lato</option>
                <option value="'Merriweather', serif">Merriweather</option>
                <option value="'Lora', serif">Lora</option>
            </select>
        </div>

        <div class="control-group">
            <label>Name Size <span class="range-value" id="nameSize">2.2rem</span></label>
            <input type="range" id="fontSizeName" min="1.5" max="4" step="0.1" value="2.2" 
                   oninput="updateRange(this, 'nameSize', '--font-size-name', 'rem')">
        </div>

        <div class="control-group">
            <label>Body Size <span class="range-value" id="bodySize">0.9rem</span></label>
            <input type="range" id="fontSizeBody" min="0.7" max="1.2" step="0.05" value="0.9" 
                   oninput="updateRange(this, 'bodySize', '--font-size-body', 'rem')">
        </div>

        <div class="control-group">
            <label>Line Height <span class="range-value" id="lineHeight">1.5</span></label>
            <input type="range" id="lineHeightCtrl" min="1.2" max="2.2" step="0.1" value="1.5" 
                   oninput="updateRange(this, 'lineHeight', '--line-height', '')">
        </div>

        <h3><i class="fas fa-palette"></i> Colors</h3>

        <div class="control-group">
            <label>Accent Color</label>
            <input type="color" id="accentColorCustom" value="#2b6cb0" 
                   oninput="updateCSS('--accent', this.value)">
        </div>

        <div class="color-preset">
            <div class="color-preset-btn" style="background: #2b6cb0;" onclick="updateCSS('--accent', '#2b6cb0'); document.getElementById('accentColorCustom').value='#2b6cb0'"></div>
            <div class="color-preset-btn" style="background: #38b2ac;" onclick="updateCSS('--accent', '#38b2ac'); document.getElementById('accentColorCustom').value='#38b2ac'"></div>
            <div class="color-preset-btn" style="background: #e53e3e;" onclick="updateCSS('--accent', '#e53e3e'); document.getElementById('accentColorCustom').value='#e53e3e'"></div>
            <div class="color-preset-btn" style="background: #805ad5;" onclick="updateCSS('--accent', '#805ad5'); document.getElementById('accentColorCustom').value='#805ad5'"></div>
            <div class="color-preset-btn" style="background: #dd6b20;" onclick="updateCSS('--accent', '#dd6b20'); document.getElementById('accentColorCustom').value='#dd6b20'"></div>
            <div class="color-preset-btn" style="background: #000000;" onclick="updateCSS('--accent', '#000000'); document.getElementById('accentColorCustom').value='#000000'"></div>
            <div class="color-preset-btn" style="background: #48bb78;" onclick="updateCSS('--accent', '#48bb78'); document.getElementById('accentColorCustom').value='#48bb78'"></div>
        </div>

        <h3><i class="fas fa-ruler-combined"></i> Layout</h3>

        <div class="control-group">
            <label>Page Padding <span class="range-value" id="paddingVal">40px</span></label>
            <input type="range" id="pagePadding" min="20" max="80" step="5" value="40" 
                   oninput="updateRange(this, 'paddingVal', '--page-padding', 'px')">
        </div>

        <div class="control-group">
            <label>Section Spacing <span class="range-value" id="sectionSpaceVal">25px</span></label>
            <input type="range" id="sectionSpacing" min="10" max="50" step="5" value="25" 
                   oninput="updateRange(this, 'sectionSpaceVal', '--section-spacing', 'px')">
        </div>

        <button class="btn-reset" onclick="resetCustomization()">
            <i class="fas fa-undo"></i> Reset All
        </button>
    </div>

    <div class="preview-area" id="previewArea">
        <!-- Pages will be dynamically inserted here -->
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // --- CORE STATE ---
        let jobCount = 3;
        let educationCount = 1;

        // --- INITIALIZE ---
        function initializeResume() {
            createInitialPage();
            updateJobCount();
            updateEducationCount();

            // Add global listener for auto-pagination
            document.getElementById('previewArea').addEventListener('input', () => {
                checkPagination();
                updateStatusBar();
            });
            
            updateStatusBar();
        }

        function createInitialPage() {
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = '';
            const page = createPageStructure(1);
            previewArea.appendChild(page);
            
            setupPasteListener();
        }

        function createPageStructure(index) {
            const div = document.createElement('div');
            const uniqueId = index === 1 ? '' : `-${index}`;
            
            div.className = 'page';
            div.dataset.pageIndex = index;

            if (index > 1) {
                div.innerHTML = `
                    <header id="headerArea${uniqueId}" style="display:none;"></header>
                    <aside id="sidebarArea${uniqueId}" style="display:none;"></aside>
                    <main id="mainArea${uniqueId}"></main>
                `;
            } else {
                div.innerHTML = `
                    <header id="headerArea${uniqueId}">
                        <h1 class="name" contenteditable="true">JORDAN REYNOLDS</h1>
                        <p class="tagline" contenteditable="true">Strategic Operations Manager</p>
                        <div class="contact-info" contenteditable="true">
                            <span><i class="fas fa-envelope"></i> email@example.com</span>
                            <span><i class="fas fa-phone"></i> (555) 012-3456</span>
                            <span><i class="fab fa-linkedin"></i> linkedin.com/in/jreynolds</span>
                            <span><i class="fas fa-map-marker-alt"></i> Chicago, IL</span>
                        </div>
                    </header>

                    <aside id="sidebarArea${uniqueId}">
                        <section id="skills-section">
                            <div class="move-controls">
                                <button class="move-btn" onclick="moveElement(this, -1)" title="Move Up"><i class="fas fa-chevron-up"></i></button>
                                <button class="move-btn" onclick="moveElement(this, 1)" title="Move Down"><i class="fas fa-chevron-down"></i></button>
                            </div>
                            <h2 class="section-title">Skills</h2>
                            <ul contenteditable="true">
                                <li>Strategic Planning</li>
                                <li>Project Management (PMP)</li>
                                <li>Data Analysis (SQL, Tableau)</li>
                                <li>Team Leadership</li>
                                <li>Budget Forecasting</li>
                            </ul>
                        </section>
                        <section id="education-section">
                            <div class="move-controls">
                                <button class="move-btn" onclick="moveElement(this, -1)" title="Move Up"><i class="fas fa-chevron-up"></i></button>
                                <button class="move-btn" onclick="moveElement(this, 1)" title="Move Down"><i class="fas fa-chevron-down"></i></button>
                            </div>
                            <h2 class="section-title">Education</h2>
                            <div id="education-container"></div>
                        </section>
                    </aside>

                    <main id="mainArea${uniqueId}">
                        <section>
                            <div class="move-controls">
                                <button class="move-btn" onclick="moveElement(this, -1)" title="Move Up"><i class="fas fa-chevron-up"></i></button>
                                <button class="move-btn" onclick="moveElement(this, 1)" title="Move Down"><i class="fas fa-chevron-down"></i></button>
                            </div>
                            <h2 class="section-title">Professional Summary</h2>
                            <p contenteditable="true">
                                Results-oriented operations leader with 10+ years of experience driving efficiency and growth in the logistics and tech sectors. Proven track record of reducing costs by 15% through process optimization and leading cross-functional teams.
                            </p>
                        </section>

                        <section id="experience-section">
                            <div class="move-controls">
                                <button class="move-btn" onclick="moveElement(this, -1)" title="Move Up"><i class="fas fa-chevron-up"></i></button>
                                <button class="move-btn" onclick="moveElement(this, 1)" title="Move Down"><i class="fas fa-chevron-down"></i></button>
                            </div>
                            <h2 class="section-title">Experience</h2>
                            <div id="jobs-container"></div>
                        </section>
                    </main>
                `;
            }
            return div;
        }

        // --- REARRANGEMENT LOGIC ---
        function moveElement(btn, direction) {
            if(event) event.stopPropagation();

            const el = btn.closest('section') || btn.closest('.entry');
            if (!el) return;

            const parent = el.parentElement;
            const siblings = Array.from(parent.children);
            const index = siblings.indexOf(el);
            const targetIndex = index + direction;

            if (targetIndex >= 0 && targetIndex < siblings.length) {
                const target = siblings[targetIndex];
                
                if (direction === -1) {
                    parent.insertBefore(el, target);
                } else {
                    parent.insertBefore(target, el);
                }
                
                checkPagination();
            }
        }

        // --- STATUS BAR LOGIC ---
        function updateStatusBar() {
            const pages = document.querySelectorAll('.page');
            const count = pages.length;
            
            document.getElementById('status-page-count').textContent = `Total Pages: ${count}`;
            
            const text = document.getElementById('previewArea').innerText || "";
            const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
            document.getElementById('status-word-count').textContent = `${words} Words`;
        }

        // --- COMPACT MODE ---
        function toggleCompactMode() {
            document.body.classList.toggle('compact-mode');
            const btn = document.getElementById('compactBtn');
            btn.classList.toggle('active');
            setTimeout(checkPagination, 50);
        }

        // --- SMART PAGINATION ENGINE (ENHANCED) ---
        function checkPagination() {
            if (!document.getElementById('multiPageToggle').checked) return;

            const pages = document.querySelectorAll('.page');
            const limit = 1123; // Approx 297mm in pixels (96dpi)
            
            // 1. Forward Pass: Push overflow content forward
            let loopLimit = 0;
            while (loopLimit < 50) { 
                let moved = false;
                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i];
                    const main = page.querySelector('main');
                    
                    if (page.scrollHeight > limit) {
                        const sections = main.querySelectorAll('section');
                        if (sections.length > 0) {
                            const lastSection = sections[sections.length - 1];
                            
                            let nextPage = pages[i + 1];
                            if (!nextPage) {
                                nextPage = createPageStructure(i + 2);
                                document.getElementById('previewArea').appendChild(nextPage);
                                pages = document.querySelectorAll('.page'); 
                                setupPasteListener(nextPage); 
                            }
                            
                            const nextMain = nextPage.querySelector('main');
                            nextMain.insertBefore(lastSection, nextMain.firstChild);
                            moved = true;
                            i--;
                        }
                    }
                }
                if (!moved) break;
                loopLimit++;
            }

            // 2. Backward Pass: Pull content back to fill gaps
            for (let i = pages.length - 2; i >= 0; i--) {
                const currentPage = pages[i];
                const currentMain = currentPage.querySelector('main');
                const nextPage = pages[i + 1];
                const nextMain = nextPage.querySelector('main');
                
                const remainingSpace = limit - currentPage.scrollHeight;
                
                if (remainingSpace > 50 && nextMain.children.length > 0) {
                    const firstSectionNext = nextMain.children[0];
                    const sectionHeight = firstSectionNext.scrollHeight;
                    
                    if (sectionHeight <= remainingSpace) {
                        currentMain.appendChild(firstSectionNext);
                    }
                }
            }

            // 3. Cleanup: Remove empty pages at the end
            const allPages = document.querySelectorAll('.page');
            for (let i = allPages.length - 1; i > 0; i--) {
                const page = allPages[i];
                const main = page.querySelector('main');
                if (main.children.length === 0) {
                    page.remove();
                } else {
                    break;
                }
            }
            
            updateStatusBar();
        }

        // --- PAGE MODE TOGGLE ---
        function togglePageMode() {
            const isMultiPage = document.getElementById('multiPageToggle').checked;
            if (isMultiPage) {
                document.body.classList.remove('single-page');
                checkPagination();
            } else {
                document.body.classList.add('single-page');
            }
        }

        // --- JOB COUNT CONTROL ---
        function adjustJobCount(delta) {
            jobCount = Math.max(1, Math.min(10, jobCount + delta));
            document.getElementById('jobCountDisplay').textContent = jobCount;
            updateJobCount();
        }

        function updateJobCount() {
            const container = document.getElementById('jobs-container');
            if (!container) return;
            
            const currentJobs = container.querySelectorAll('.entry').length;
            
            if (jobCount > currentJobs) {
                for (let i = currentJobs; i < jobCount; i++) {
                    const newJob = createJobEntry(i);
                    container.appendChild(newJob);
                }
            } else if (jobCount < currentJobs) {
                const jobsToRemove = currentJobs - jobCount;
                for (let i = 0; i < jobsToRemove; i++) {
                    const lastJob = container.querySelector('.entry:last-child');
                    if (lastJob) lastJob.remove();
                }
            }
            
            setupPasteListener();
            checkPagination();
        }

        function createJobEntry(index) {
            const div = document.createElement('div');
            div.className = 'entry';
            const companies = ['Apex Logistics', 'TechCorp Industries', 'Global Solutions Inc', 'Innovation Partners', 'Enterprise Systems'];
            const titles = ['Senior Operations Manager', 'Operations Manager', 'Operations Coordinator', 'Project Manager', 'Business Analyst'];
            const locations = ['Chicago, IL', 'New York, NY', 'San Francisco, CA', 'Boston, MA', 'Austin, TX'];
            
            div.innerHTML = `
                <div class="move-controls" style="top: 5px; right: 5px;">
                    <button class="move-btn" onclick="moveElement(this, -1)" title="Move Up"><i class="fas fa-chevron-up"></i></button>
                    <button class="move-btn" onclick="moveElement(this, 1)" title="Move Down"><i class="fas fa-chevron-down"></i></button>
                </div>
                <div class="job-head">
                    <span contenteditable="true">${companies[index % companies.length]}</span>
                    <span contenteditable="true">${2023 - index * 2} – ${index === 0 ? 'Present' : (2023 - index * 2 + 2)}</span>
                </div>
                <div class="job-sub">
                    <span contenteditable="true">${titles[index % titles.length]}</span>
                    <span contenteditable="true">${locations[index % locations.length]}</span>
                </div>
                <ul contenteditable="true">
                    <li>Led cross-functional teams to deliver projects on time and under budget.</li>
                    <li>Implemented process improvements resulting in 15% efficiency gains.</li>
                    <li>Managed stakeholder relationships and client communications.</li>
                </ul>
                <button class="btn-rm" onclick="removeJobEntry(this)">Remove</button>
            `;
            return div;
        }

        function removeJobEntry(btn) {
            if (jobCount > 1) {
                btn.parentElement.remove();
                jobCount--;
                document.getElementById('jobCountDisplay').textContent = jobCount;
                checkPagination();
            }
        }

        // --- EDUCATION COUNT CONTROL ---
        function adjustEducationCount(delta) {
            educationCount = Math.max(1, Math.min(5, educationCount + delta));
            document.getElementById('eduCountDisplay').textContent = educationCount;
            updateEducationCount();
        }

        function updateEducationCount() {
            const container = document.getElementById('education-container');
            if (!container) return;
            
            const currentEdu = container.querySelectorAll('.entry').length;
            
            if (educationCount > currentEdu) {
                for (let i = currentEdu; i < educationCount; i++) {
                    const newEdu = createEducationEntry(i);
                    container.appendChild(newEdu);
                }
            } else if (educationCount < currentEdu) {
                const eduToRemove = currentEdu - educationCount;
                for (let i = 0; i < eduToRemove; i++) {
                    const lastEdu = container.querySelector('.entry:last-child');
                    if (lastEdu) lastEdu.remove();
                }
            }
            
            setupPasteListener();
            checkPagination();
        }

        function createEducationEntry(index) {
            const div = document.createElement('div');
            div.className = 'entry';
            const schools = ['Northwestern University', 'Stanford University', 'MIT', 'Harvard University', 'UC Berkeley'];
            const degrees = ['MBA, Strategy', 'MS, Computer Science', 'BS, Business Administration', 'MA, Economics', 'BS, Engineering'];
            
            div.innerHTML = `
                <div class="move-controls" style="top: 5px; right: 5px;">
                    <button class="move-btn" onclick="moveElement(this, -1)" title="Move Up"><i class="fas fa-chevron-up"></i></button>
                    <button class="move-btn" onclick="moveElement(this, 1)" title="Move Down"><i class="fas fa-chevron-down"></i></button>
                </div>
                <div style="font-weight:700" contenteditable="true">${schools[index % schools.length]}</div>
                <div style="font-size:0.85rem;" contenteditable="true">${degrees[index % degrees.length]}</div>
                <button class="btn-rm" onclick="removeEducationEntry(this)" style="position: absolute; right: 0; top: 0;">Remove</button>
            `;
            return div;
        }

        function removeEducationEntry(btn) {
            if (educationCount > 1) {
                btn.parentElement.remove();
                educationCount--;
                document.getElementById('eduCountDisplay').textContent = educationCount;
                checkPagination();
            }
        }

        // --- CORE FUNCTIONS ---
        function closeSplash() { 
            document.getElementById('splashScreen').classList.add('hidden'); 
        }

        function applyTemplate(val) { 
            document.body.className = document.body.className.replace(/\btpl-\S+/g, ''); 
            document.body.classList.add(val);
            if (!document.getElementById('multiPageToggle').checked) {
                document.body.classList.add('single-page');
            }
        }

        function applyBg(val) { 
            document.body.className = document.body.className.replace(/\bbg-\S+/g, ''); 
            document.body.classList.add(val); 
        }

        function applyColor(val) { 
            document.documentElement.style.setProperty('--accent', val); 
            document.getElementById('accentColorCustom').value = val;
        }

        // --- EXPORT SIDEBAR FUNCTIONS ---
        function toggleExportSidebar() {
            const panel = document.getElementById('exportSidebar');
            const preview = document.getElementById('previewArea');
            panel.classList.toggle('open');
            preview.classList.toggle('panel-open-left');
        }
        
        function closeExportSidebar() {
            document.getElementById('exportSidebar').classList.remove('open');
            document.getElementById('previewArea').classList.remove('panel-open-left');
        }

        // --- IMAGE/SVG GENERATION HELPERS ---
        function getExportClone() {
            const node = document.getElementById('previewArea').cloneNode(true);
            
            // --- 1. Replace FontAwesome icons with Inline SVGs ---
            const icons = node.querySelectorAll('i');
            icons.forEach(icon => {
                const classList = icon.classList;
                let pathData = '';
                let viewBox = "0 0 512 512";

                // Define exact paths for icons used in the resume (FontAwesome 6.0.0)
                if (classList.contains('fa-envelope')) {
                    // Envelope
                    pathData = "M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z";
                } 
                else if (classList.contains('fa-phone')) {
                    // Phone
                    pathData = "M164.9 24.6c-7.7-18.6-28-28.5-47.4-20.2L36.4 42.6c-22.7 9.7-39 32.6-38.2 57.2.7 20.7 5.2 41.8 13.4 62.2 18.9 46.4 50 88.5 91 120.7 43 33.6 96.5 52.3 151.9 53.3 24.4.5 47.8-9.7 63.2-28.9l38.4-50.6c11.7-15.4 8.7-37.3-6.8-48.6l-59.7-44.3c-15.8-11.7-38.1-8.3-49.9 8.1l-18.9 25.5c-34.6-18.7-63.6-45.6-82.5-80.1l25.5-18.9c16.4-11.8 19.8-34.1 8.1-49.9l-44.3-59.7z";
                } 
                else if (classList.contains('fa-map-marker-alt')) {
                    // Map Marker Alt
                    pathData = "M384 192c0 87.4-117 243-168.3 307.2-12.3 15.3-35.1 15.3-47.4 0C117 435 0 279.4 0 192C0 86 86 0 192 0s192 86 192 192z";
                } 
                else if (classList.contains('fa-linkedin')) {
                    // LinkedIn (Brand)
                    pathData = "M100.28 484H8.004V180.9h92.276V484zM54.27 138.9c-29.7 0-53.8-24.1-53.8-53.8s24.1-53.8 53.8-53.8 53.8 24.1 53.8 53.8-24.1 53.8-53.8 53.8zm424.4 345.2h-92.28V332.4c0-34.7-.7-79.2-48.3-79.2-48.3 0-55.7 37.7-55.7 76.7V484H179.7V180.9h89.1v40.8h1.3c12.4-23.5 42.7-48.3 87.9-48.3 94 0 111.4 61.9 111.4 142.3V484z";
                }

                if (pathData) {
                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svg.setAttribute("viewBox", viewBox);
                    svg.setAttribute("aria-hidden", "true");
                    
                    // Copy any custom classes from the icon to the svg
                    svg.className = icon.className;
                    
                    // Get the computed color from the original HTML icon and apply it inline
                    // This ensures the exported SVG matches the color perfectly (Accent, Text-Muted, etc.)
                    const computedColor = window.getComputedStyle(icon).color;
                    
                    // Set SVG styles to match FontAwesome's rendering exactly
                    svg.style.cssText = `
                        display: inline-block;
                        height: 1em;
                        overflow: visible;
                        vertical-align: -0.125em;
                        width: 1em;
                        color: ${computedColor};
                    `;
                    
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    path.setAttribute("d", pathData);
                    path.setAttribute("fill", "currentColor");
                    
                    svg.appendChild(path);
                    icon.parentNode.replaceChild(svg, icon);
                }
            });

            // --- 2. Clean up UI elements ---
            node.querySelectorAll('.move-controls, .btn-rm, .section-controls').forEach(el => el.remove());
            
            // Convert inputs/textareas to text
            node.querySelectorAll('input, textarea').forEach(el => {
                const text = document.createTextNode(el.value);
                el.parentNode.replaceChild(text, el);
            });

            // --- 3. Resolve CSS Variables for inline styles ---
            const resolveVars = (el) => {
                const computed = window.getComputedStyle(el);
                const style = el.style;
                
                if (style.color && style.color.includes('var')) {
                    el.style.color = computed.color;
                }
                if (style.backgroundColor && style.backgroundColor.includes('var')) {
                    el.style.backgroundColor = computed.backgroundColor;
                }
                if (style.borderColor && style.borderColor.includes('var')) {
                    el.style.borderColor = computed.borderColor;
                }
                
                Array.from(el.children).forEach(resolveVars);
            };
            resolveVars(node);

            return node;
        }

        function getSVGString() {
            const clone = getExportClone();
            const serializer = new XMLSerializer();
            const data = serializer.serializeToString(clone);
            
            const styleContent = document.querySelector('style').innerHTML;

            const rgbToHex = (rgb) => {
                if (!rgb || rgb === 'transparent') return '#000000';
                if (rgb.startsWith('#')) return rgb;
                const rgbValues = rgb.match(/\d+/g);
                if (!rgbValues) return '#000000';
                return "#" + ((1 << 24) + (parseInt(rgbValues[0]) << 16) + (parseInt(rgbValues[1]) << 8) + parseInt(rgbValues[2])).toString(16).slice(1);
            };

            const accentColor = rgbToHex(getComputedStyle(document.documentElement).getPropertyValue('--accent').trim());
            const textColor = rgbToHex(getComputedStyle(document.documentElement).getPropertyValue('--text-main').trim());

            // Escape & for XML
            const fontUrl = "https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&amp;family=Merriweather:ital,wght@0,300;0,700,1,400&amp;family=Fira+Code:wght@400;600&amp;family=Playfair+Display:ital,wght@0,400;0,700,1,400&amp;family=Lato:wght@300;400;700&amp;family=Oswald:wght@400;600&amp;family=Roboto+Slab:wght@300;400;700&amp;family=Raleway:wght@300;400;700&amp;family=Montserrat:wght@400;700&amp;family=Open+Sans:wght@400;600&amp;family=Lora:ital,wght@0,400;0,600,1,400&amp;family=Karla:wght@400;700&amp;family=Space+Mono:wght@400;700&amp;display=swap";

            return `
            <svg xmlns="http://www.w3.org/2000/svg" width="794" height="1123">
                <defs>
                    <style type="text/css"><![CDATA[
                        @import url('${fontUrl}');
                        
                        :root {
                            --accent: ${accentColor};
                            --text-main: ${textColor};
                            --primary: #2d3748;
                        }
                        
                        ${styleContent}
                        
                        /* Force background rendering for export */
                        .page { 
                            -webkit-print-color-adjust: exact; 
                            print-color-adjust: exact; 
                            background-color: white !important;
                            color-adjust: exact;
                        }
                    ]]></style>
                </defs>
                <foreignObject width="100%" height="100%">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="background:white; width:100%; height:100%;">
                        ${data}
                    </div>
                </foreignObject>
            </svg>`;
        }

        // --- EXPORT FUNCTIONS ---
        function exportPDF() {
            const filename = document.getElementById('exportFilename').value || 'Resume';
            const oldTitle = document.title;
            document.title = filename;
            closeExportSidebar();
            
            // Trigger print after a brief delay to allow UI transitions to finish
            setTimeout(() => {
                window.print();
                document.title = oldTitle;
            }, 300);
        }

        function exportPNG() {
            const filename = document.getElementById('exportFilename').value || 'resume';
            closeExportSidebar();

            const svgString = getSVGString();
            const img = new Image();
            const blob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
            const url = URL.createObjectURL(blob);

            img.onload = function() {
                const canvas = document.createElement('canvas');
                // High resolution scale (2x for Retina/Print quality)
                const scale = 2;
                canvas.width = 794 * scale; 
                canvas.height = 1123 * scale;
                const ctx = canvas.getContext('2d');
                
                ctx.scale(scale, scale);
                ctx.fillStyle = "white";
                ctx.fillRect(0, 0, 794, 1123);
                
                ctx.drawImage(img, 0, 0, 794, 1123);
                
                const pngUrl = canvas.toDataURL("image/png");
                const downloadLink = document.createElement("a");
                downloadLink.href = pngUrl;
                downloadLink.download = filename + ".png";
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(url);
            };
            
            img.onerror = function() {
                alert("Error generating image. External fonts or strict browser security settings might be blocking the conversion.");
            };
            img.src = url;
        }

        function exportSVG() {
            const filename = document.getElementById('exportFilename').value || 'resume';
            closeExportSidebar();
            
            const svgString = getSVGString();
            const blob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            
            const downloadLink = document.createElement("a");
            downloadLink.href = url;
            downloadLink.download = filename + ".svg";
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
        }

        // --- ENHANCED DOCX EXPORT ---
        function exportDOCX() {
            const filename = document.getElementById('exportFilename').value || 'resume';
            closeExportSidebar();
            
            const pages = document.querySelectorAll('.page');
            let docxContent = '';
            
            // Helper to convert computed RGB color to Word Hex format (RRGGBB)
            const getColorHex = (element) => {
                const color = window.getComputedStyle(element).color;
                if (!color || color === 'rgba(0, 0, 0, 0)') return '000000';
                const rgb = color.match(/\d+/g);
                if (!rgb) return '000000';
                return ((1 << 24) + (parseInt(rgb[0]) << 16) + (parseInt(rgb[1]) << 8) + parseInt(rgb[2])).toString(16).slice(1);
            };

            // Helper to parse font size to half-points (Word uses half-points)
            const getFontSize = (element) => {
                const size = window.getComputedStyle(element).fontSize; // e.g., "16px"
                const px = parseFloat(size);
                // Approximate conversion: 1px = 1.5 half-points
                return Math.round(px * 2); 
            };

            const escapeXML = (str) => {
                if(!str) return '';
                return str.replace(/&/g, '&amp;')
                          .replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;')
                          .replace(/"/g, '&quot;')
                          .replace(/'/g, '&apos;');
            };

            const processNode = (node) => {
                let xml = '';
                
                // Skip UI controls and icons
                if (node.classList && (node.classList.contains('move-controls') || node.classList.contains('btn-rm') || node.tagName === 'I')) {
                    return '';
                }

                const isBold = window.getComputedStyle(node).fontWeight === 'bold' || window.getComputedStyle(node).fontWeight === '700' || node.tagName === 'STRONG';
                const isItalic = window.getComputedStyle(node).fontStyle === 'italic' || node.tagName === 'EM';
                const color = getColorHex(node);
                const fontSize = getFontSize(node);

                // --- Structure Handlers ---
                
                // 1. NAME (H1)
                if (node.classList.contains('name') || node.tagName === 'H1') {
                    const accent = document.documentElement.style.getPropertyValue('--accent') || '2b6cb0';
                    // Convert var to hex if needed, otherwise simple hex
                    let hexColor = accent.startsWith('#') ? accent.replace('#', '') : '2b6cb0';
                    
                    xml += `<w:p><w:pPr><w:pStyle w:val="Title"/></w:pPr><w:r><w:rPr><w:color w:val="${hexColor}"/><w:sz w:val="${fontSize}"/></w:rPr><w:t>${escapeXML(node.textContent)}</w:t></w:r></w:p>`;
                } 
                
                // 2. SECTION TITLES (H2)
                else if (node.classList.contains('section-title') || (node.tagName === 'H2' && node.classList.contains('name') === false)) {
                    const accent = document.documentElement.style.getPropertyValue('--accent') || '2b6cb0';
                    let hexColor = accent.startsWith('#') ? accent.replace('#', '') : '2b6cb0';
                    
                    xml += `<w:p><w:pPr><w:pStyle w:val="Heading2"/></w:pPr><w:r><w:rPr><w:color w:val="${hexColor}"/><w:b/><w:sz w:val="${fontSize}"/></w:rPr><w:t>${escapeXML(node.textContent)}</w:t></w:r></w:p>`;
                } 
                
                // 3. LISTS (UL)
                else if (node.tagName === 'UL') {
                    node.querySelectorAll('li').forEach(li => {
                        xml += `<w:p><w:pPr><w:numPr><w:ilvl w:val="0"/><w:numId w:val="1"/></w:numPr></w:pPr><w:r><w:t>${escapeXML(li.textContent)}</w:t></w:r></w:p>`;
                    });
                }
                
                // 4. PARAGRAPHS AND DIVS
                else if (node.tagName === 'P' || node.tagName === 'DIV') {
                    // Handle Job Header (Company | Date)
                    if (node.classList.contains('job-head')) {
                        const spans = node.querySelectorAll('span');
                        const company = spans[0] ? spans[0].textContent : node.childNodes[0].textContent;
                        const date = spans[1] ? spans[1].textContent : '';
                        
                        xml += `<w:p><w:r><w:rPr><w:b/><w:sz w:val="${fontSize}"/></w:rPr><w:t>${escapeXML(company)}</w:t></w:r>`;
                        if (date) xml += `<w:r><w:tab/><w:rPr><w:sz w:val="${fontSize}"/></w:rPr><w:t xml:space="preserve">   ${escapeXML(date)}</w:t></w:r>`;
                        xml += `</w:p>`;
                        return xml;
                    }
                    
                    // Handle Job Sub (Title | Location)
                    if (node.classList.contains('job-sub')) {
                        const spans = node.querySelectorAll('span');
                        const title = spans[0] ? spans[0].textContent : node.childNodes[0].textContent;
                        const loc = spans[1] ? spans[1].textContent : '';
                        
                        xml += `<w:p><w:r><w:rPr><w:i/><w:sz w:val="${fontSize}"/></w:rPr><w:t>${escapeXML(title)}</w:t></w:r>`;
                        if (loc) xml += `<w:r><w:tab/><w:rPr><w:sz w:val="${fontSize}"/></w:rPr><w:t xml:space="preserve"> – ${escapeXML(loc)}</w:t></w:r>`;
                        xml += `</w:p>`;
                        return xml;
                    }

                    // Handle Tagline
                    if (node.classList.contains('tagline')) {
                        xml += `<w:p><w:pPr><w:pStyle w:val="Subtitle"/></w:pPr><w:r><w:rPr><w:color w:val="666666"/><w:i/><w:sz w:val="${fontSize}"/></w:rPr><w:t>${escapeXML(node.textContent)}</w:t></w:r></w:p>`;
                        return xml;
                    }

                    // Contact Info container - inline spans
                    if (node.classList.contains('contact-info')) {
                        // Flatten contact info into one line or multiple paragraphs
                        Array.from(node.children).forEach(span => {
                             if(span.tagName === 'SPAN') {
                                 xml += `<w:r><w:t>${escapeXML(span.textContent)}    </w:t></w:r>`;
                             }
                        });
                        xml += `<w:p/><w:p/>`; // Add spacing
                        return xml;
                    }

                    // Standard paragraph with style checks
                    const text = node.textContent.trim();
                    if (text && !node.querySelector('div, p, ul, h1, h2, section')) {
                        let rPr = `<w:sz w:val="${fontSize}"/>`;
                        if (isBold) rPr += `<w:b/>`;
                        if (isItalic) rPr += `<w:i/>`;
                        if (color !== '000000') rPr += `<w:color w:val="${color}"/>`;
                        
                        xml += `<w:p><w:r><w:rPr>${rPr}</w:rPr><w:t>${escapeXML(text)}</w:t></w:r></w:p>`;
                    } else {
                        // Recurse for containers
                        Array.from(node.children).forEach(child => xml += processNode(child));
                    }
                }
                
                // 5. STRUCTURAL BLOCKS
                else if (['SECTION', 'HEADER', 'MAIN', 'ASIDE'].includes(node.tagName)) {
                    Array.from(node.children).forEach(child => xml += processNode(child));
                }
                
                return xml;
            };

            // Process Pages
            pages.forEach((page, index) => {
                const header = page.querySelector('header');
                const main = page.querySelector('main');
                const sidebar = page.querySelector('aside');

                if (header && header.style.display !== 'none') docxContent += processNode(header);
                if (main) docxContent += processNode(main);
                if (sidebar && sidebar.style.display !== 'none') docxContent += processNode(sidebar);

                if (index < pages.length - 1) {
                    docxContent += `<w:p><w:r><w:br w:type="page"/></w:r></w:p>`;
                }
            });
            
            generateDOCX(docxContent, filename);
        }

        function generateDOCX(content, filename) {
            const zip = new JSZip();
            
            // Content Types
            zip.file("[Content_Types].xml", `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Default Extension="xml" ContentType="application/xml"/><Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/><Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/></Types>`);
            
            // Relationships
            zip.folder("_rels").file(".rels", `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/></Relationships>`);
            
            zip.folder("word/_rels").file("document.xml.rels", `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/></Relationships>`);

            // Enhanced Styles Definition
            zip.folder("word").file("styles.xml", `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
            <w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
                <w:docDefaults>
                    <w:rPrDefault>
                        <w:rPr>
                            <w:rFonts w:ascii="Calibri" w:hAnsi="Calibri"/>
                            <w:sz w:val="22"/>
                            <w:color w:val="000000"/>
                        </w:rPr>
                    </w:rPrDefault>
                </w:docDefaults>
                <!-- Title Style (Name) -->
                <w:style w:type="paragraph" w:styleId="Title">
                    <w:name w:val="Title"/>
                    <w:rPr>
                        <w:b/>
                        <w:sz w:val="44"/>
                        <w:szCs w:val="44"/>
                    </w:rPr>
                </w:style>
                <!-- Subtitle Style (Tagline) -->
                <w:style w:type="paragraph" w:styleId="Subtitle">
                    <w:name w:val="Subtitle"/>
                    <w:rPr>
                        <w:i/>
                        <w:color w:val="666666"/>
                        <w:sz w:val="24"/>
                    </w:rPr>
                </w:style>
                <!-- Heading 2 Style (Sections) -->
                <w:style w:type="paragraph" w:styleId="Heading2">
                    <w:name w:val="Heading 2"/>
                    <w:rPr>
                        <w:b/>
                        <w:sz w:val="28"/>
                        <w:color w:val="2b6cb0"/>
                    </w:rPr>
                </w:style>
                <!-- List Style -->
                <w:style w:type="numbering" w:styleId="ListParagraph">
                    <w:name w:val="List Paragraph"/>
                    <w:pPr>
                        <w:numPr>
                            <w:numId w:val="1"/>
                        </w:numPr>
                    </w:pPr>
                </w:style>
            </w:styles>`);

            // Document Body
            zip.folder("word").file("document.xml", `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"><w:body>${content}</w:body></w:document>`);
            
            zip.generateAsync({type: "blob"}).then(function(content) {
                const url = URL.createObjectURL(content);
                const a = document.createElement("a");
                a.href = url;
                a.download = filename + ".docx";
                a.click();
                URL.revokeObjectURL(url);
            });
        }


        // --- CUSTOMIZATION PANEL ---
        function toggleCustomize() {
            const panel = document.getElementById('customizePanel');
            const btn = document.getElementById('customizeBtn');
            const preview = document.getElementById('previewArea');
            panel.classList.toggle('open');
            btn.classList.toggle('active');
            preview.classList.toggle('panel-open-right');
        }

        function updateCSS(variable, value) {
            document.documentElement.style.setProperty(variable, value);
            if (variable === '--accent') {
                document.getElementById('accentColor').value = value;
                document.getElementById('accentColorCustom').value = value;
            }
        }

        function updateRange(input, displayId, cssVar, unit) {
            const value = input.value + unit;
            document.getElementById(displayId).textContent = value;
            updateCSS(cssVar, value);
            setTimeout(checkPagination, 100);
        }

        function resetCustomization() {
            if (!confirm('Reset all customizations to default?')) return;
            
            const defaults = {
                '--primary': '#2d3748',
                '--accent': '#2b6cb0',
                '--bg-page': '#ffffff',
                '--text-main': '#1a202c',
                '--text-muted': '#4a5568',
                '--border-color': '#e2e8f0',
                '--font-head': "'Inter', sans-serif",
                '--font-body': "'Inter', sans-serif",
                '--font-size-name': '2.2rem',
                '--font-size-section': '1.1rem',
                '--font-size-body': '0.9rem',
                '--line-height': '1.5',
                '--page-padding': '40px',
                '--sidebar-width': '30%',
                '--column-gap': '30px',
                '--row-gap': '20px',
                '--section-spacing': '25px'
            };
            
            for (const [key, value] of Object.entries(defaults)) {
                updateCSS(key, value);
            }
            
            document.getElementById('fontHead').value = "'Inter', sans-serif";
            document.getElementById('fontBody').value = "'Inter', sans-serif";
            document.getElementById('fontSizeName').value = 2.2;
            document.getElementById('nameSize').textContent = '2.2rem';
            document.getElementById('fontSizeBody').value = 0.9;
            document.getElementById('bodySize').textContent = '0.9rem';
            document.getElementById('lineHeightCtrl').value = 1.5;
            document.getElementById('lineHeight').textContent = '1.5';
            document.getElementById('accentColorCustom').value = '#2b6cb0';
            document.getElementById('accentColor').value = '#2b6cb0';
            document.getElementById('pagePadding').value = 40;
            document.getElementById('paddingVal').textContent = '40px';
            document.getElementById('sectionSpacing').value = 25;
            document.getElementById('sectionSpaceVal').textContent = '25px';
            
            jobCount = 3;
            educationCount = 1;
            document.getElementById('jobCountDisplay').textContent = jobCount;
            document.getElementById('eduCountDisplay').textContent = educationCount;
            document.getElementById('multiPageToggle').checked = false;
            document.body.classList.add('single-page');
            
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = '';
            createInitialPage();
            updateJobCount();
            updateEducationCount();
        }

        // --- CONTENT EDITING ---
        function setupPasteListener(root = document) {
            const scope = root === document ? document : root;
            scope.querySelectorAll('[contenteditable]').forEach(el => {
                const newEl = el.cloneNode(true);
                el.parentNode.replaceChild(newEl, el);
                newEl.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const text = (e.originalEvent || e).clipboardData.getData('text/plain');
                    document.execCommand('insertText', false, text);
                });
            });
        }

        // --- SAVE / LOAD ---
        function saveProject() {
            const filename = document.getElementById('exportFilename').value || 'resume-master';
            const config = { 
                template: document.getElementById('templateSelect').value, 
                bg: document.getElementById('bgSelect').value, 
                color: document.getElementById('accentColor').value,
                jobCount: jobCount,
                educationCount: educationCount,
                multiPage: document.getElementById('multiPageToggle').checked,
                customization: {
                    fontHead: document.getElementById('fontHead').value,
                    fontBody: document.getElementById('fontBody').value,
                    fontSizeName: document.getElementById('fontSizeName').value,
                    fontSizeBody: document.getElementById('fontSizeBody').value,
                    lineHeight: document.getElementById('lineHeightCtrl').value,
                    accentColor: document.getElementById('accentColorCustom').value,
                    pagePadding: document.getElementById('pagePadding').value,
                    sectionSpacing: document.getElementById('sectionSpacing').value
                }
            };
            
            const pages = [];
            document.querySelectorAll('.page').forEach(page => {
                pages.push({
                    header: page.querySelector('header')?.innerHTML || '',
                    sidebar: page.querySelector('aside')?.innerHTML || '',
                    main: page.querySelector('main')?.innerHTML || ''
                });
            });
            
            const content = { pages };
            
            const blob = new Blob([JSON.stringify({ config, content })], {type: 'application/json'});
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = filename + '.resume'; 
            a.click();
        }

        function triggerLoad() { document.getElementById('fileLoader').click(); }
        
        function handleFileLoad(input) {
            const file = input.files[0]; 
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = JSON.parse(e.target.result);
                
                document.getElementById('templateSelect').value = data.config.template; 
                applyTemplate(data.config.template);
                document.getElementById('bgSelect').value = data.config.bg; 
                applyBg(data.config.bg);
                document.getElementById('accentColor').value = data.config.color; 
                applyColor(data.config.color);
                
                if (data.config.jobCount !== undefined) {
                    jobCount = data.config.jobCount;
                    document.getElementById('jobCountDisplay').textContent = jobCount;
                }
                
                if (data.config.educationCount !== undefined) {
                    educationCount = data.config.educationCount;
                    document.getElementById('eduCountDisplay').textContent = educationCount;
                }
                
                if (data.config.multiPage !== undefined) {
                    document.getElementById('multiPageToggle').checked = data.config.multiPage;
                    if (data.config.multiPage) {
                        document.body.classList.remove('single-page');
                    } else {
                        document.body.classList.add('single-page');
                    }
                }
                
                if (data.config.customization) {
                    const c = data.config.customization;
                    document.getElementById('fontHead').value = c.fontHead;
                    updateCSS('--font-head', c.fontHead);
                    document.getElementById('fontBody').value = c.fontBody;
                    updateCSS('--font-body', c.fontBody);
                    document.getElementById('fontSizeName').value = c.fontSizeName;
                    updateRange(document.getElementById('fontSizeName'), 'nameSize', '--font-size-name', 'rem');
                    document.getElementById('fontSizeBody').value = c.fontSizeBody;
                    updateRange(document.getElementById('fontSizeBody'), 'bodySize', '--font-size-body', 'rem');
                    document.getElementById('lineHeightCtrl').value = c.lineHeight;
                    updateRange(document.getElementById('lineHeightCtrl'), 'lineHeight', '--line-height', '');
                    document.getElementById('accentColorCustom').value = c.accentColor;
                    updateCSS('--accent', c.accentColor);
                    document.getElementById('pagePadding').value = c.pagePadding;
                    updateRange(document.getElementById('pagePadding'), 'paddingVal', '--page-padding', 'px');
                    document.getElementById('sectionSpacing').value = c.sectionSpacing;
                    updateRange(document.getElementById('sectionSpacing'), 'sectionSpaceVal', '--section-spacing', 'px');
                }
                
                if (data.content && data.content.pages) {
                    const previewArea = document.getElementById('previewArea');
                    previewArea.innerHTML = '';
                    
                    data.content.pages.forEach((pageData, index) => {
                        const page = createPageStructure(index + 1);
                        page.querySelector('header').innerHTML = pageData.header;
                        page.querySelector('aside').innerHTML = pageData.sidebar;
                        page.querySelector('main').innerHTML = pageData.main;
                        
                        const header = page.querySelector('header');
                        const aside = page.querySelector('aside');
                        if (index > 0) {
                            header.style.display = 'none';
                            aside.style.display = 'none';
                        } else {
                            header.style.display = '';
                            aside.style.display = '';
                        }
                        
                        previewArea.appendChild(page);
                    });
                }
                
                setupPasteListener(); 
                closeSplash();
                updateStatusBar();
            };
            reader.readAsText(file);
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', initializeResume);
    </script>
</body>
</html>
